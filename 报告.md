# Tetris Game - COMP2042 Coursework

## GitHub Repository

[GitHub Repository Link](https://github.com/YOUR_USERNAME/CW2025)  
*注意：请替换为你的实际GitHub仓库链接*

## 编译说明

### 环境要求

- **Java开发工具包 (JDK)**: 版本23或更高
- **Maven**: 版本3.6+（或使用项目自带的Maven wrapper）
- **IDE**: IntelliJ IDEA、Eclipse或任何Java IDE（可选）

### 分步编译指南

1. **设置JAVA_HOME环境变量**（如果尚未设置）:
   ```bash
   # Windows PowerShell
   $env:JAVA_HOME = "D:\Program Files\Java\jdk-23.0.2"
   
   # Linux/Mac
   export JAVA_HOME=/path/to/jdk-23
   ```

2. **进入项目目录**:
   ```bash
   cd CW2025
   ```

3. **编译项目**:
   ```bash
   # 使用Maven wrapper (Windows)
   .\mvnw.cmd clean compile
   
   # 使用Maven wrapper (Linux/Mac)
   ./mvnw clean compile
   
   # 或使用系统Maven
   mvn clean compile
   ```

4. **运行应用程序**:
   ```bash
   # 使用Maven wrapper
   .\mvnw.cmd javafx:run
   
   # 或使用系统Maven
   mvn javafx:run
   ```

### 依赖项

所有依赖项由Maven管理，将自动下载：
- JavaFX Controls 21.0.6
- JavaFX FXML 21.0.6
- JUnit 5.12.1（用于测试）

### 特殊设置

- 项目使用Java 23作为源代码和目标版本
- JavaFX模块通过Maven依赖项包含
- 除了设置JAVA_HOME外，无需额外配置

## 已实现且运行正常的功能

### 核心游戏功能

1. **基础俄罗斯方块玩法**
   - ✅ 方块下落机制
   - ✅ 方块旋转（UP键或W键）
   - ✅ 方块移动（LEFT/RIGHT键或A/D键）
   - ✅ 方块加速下落（DOWN键或S键）
   - ✅ 行消除（当行填满时）
   - ✅ 分数计算和显示
   - ✅ 游戏结束检测

2. **用户界面**
   - ✅ 游戏板可视化
   - ✅ 当前方块显示
   - ✅ 下一个方块预览
   - ✅ 分数实时显示（新增功能）
   - ✅ 游戏结束面板
   - ✅ 键盘控制

3. **分数实时统计显示功能（新增功能）**
   - ✅ 实时分数显示
   - ✅ 分数自动更新（使用JavaFX属性绑定）
   - ✅ 分数显示区域位于游戏板右侧
   - ✅ 美观的分数显示样式

4. **代码重构（维护工作）**
   - ✅ 通过常量消除魔法数字
   - ✅ 代码组织改进
   - ✅ 设计模式实现（颜色映射的策略模式）
   - ✅ 完整的Javadoc文档
   - ✅ 改进的代码封装
   - ✅ 方法提取以减少代码重复

## 已实现但运行异常的功能

*无 - 所有已实现的功能均正常工作。*

## 未实现的功能

1. **暂停/继续功能**
   - **位置**: `GuiController.pauseGame()` 方法
   - **原因**: 暂停游戏方法存在但仅请求焦点。完整的暂停/继续功能（包括时间线控制）未实现。

## 新增Java类

### 1. `GameConstants`（工具类）
- **位置**: `com.comp2042.util.GameConstants`
- **用途**: 集中管理游戏中的所有魔法数字和配置值
- **主要功能**:
  - 游戏板尺寸（宽度、高度）
  - 初始方块位置
  - 显示相关常量（方块大小、窗口尺寸）
  - 游戏循环间隔
  - 分数计算常量
  - 颜色索引常量
- **优势**: 通过消除魔法数字提高代码可读性和可维护性

### 2. `ColorMapper`（工具类）
- **位置**: `com.comp2042.util.ColorMapper`
- **用途**: 使用策略模式实现颜色映射，将颜色逻辑从GUI控制器中分离
- **主要功能**:
  - 静态方法 `getColor(int colorIndex)` 根据颜色索引返回对应的Paint对象
  - 使用Java 17的switch表达式简化代码
- **优势**: 
- 遵循单一职责原则
  - 颜色管理集中化，易于扩展
- 提高代码复用性

## 修改的Java类

### 1. `GameConstants`
- **位置**: `com.comp2042.util.GameConstants`
- **修改内容**（Bug修复）:
  - 将 `INITIAL_BRICK_Y` 从10改为0
  - 添加注释说明初始位置在游戏板顶部
- **修改理由**: 修复游戏过早结束的bug，确保方块从顶部正确生成

### 2. `SimpleBoard`
- **位置**: `com.comp2042.SimpleBoard`
- **修改内容**:
  - 为类和构造函数添加Javadoc文档
  - 在 `createNewBrick()` 方法中使用 `GameConstants.INITIAL_BRICK_X` 和 `INITIAL_BRICK_Y` 替代硬编码的 `4, 10`
  - **Bug修复**: 改进 `createNewBrick()` 方法的游戏结束判断逻辑，添加注释说明游戏结束条件
- **修改理由**: 修复游戏过早结束的bug，提高代码可读性，便于配置管理

### 3. `MatrixOperations`
- **位置**: `com.comp2042.MatrixOperations`
- **修改内容**:
  - 为所有公共方法添加完整的Javadoc文档
  - 改进方法命名和逻辑：
    - 简化 `checkOutOfBound()` 的布尔逻辑
    - 改进 `copy()` 中的变量命名（myInt → copy, aMatrix → row）
    - 改进 `merge()` 中的变量命名（copy → merged）
    - 改进 `checkRemoving()` 中的变量命名（tmp → newMatrix, newRows → remainingRows）
     - 使用常量 `GameConstants.BASE_SCORE_PER_LINE` 替代硬编码的 `50`
     - 添加更清晰的注释说明算法逻辑
  - 将类声明为 `final` 以防止继承
  - 改进构造函数，使用 `AssertionError` 防止实例化
- **修改理由**: 提高代码可读性，消除魔法数字，提升代码质量

### 4. `GuiController`
- **位置**: `com.comp2042.GuiController`
- **修改内容**:
  - 将所有硬编码值（BRICK_SIZE, -42, 400等）替换为 `GameConstants` 中的常量
  - 统一使用 `ColorMapper.getColor()` 获取颜色
  - 将旧的 `getFillColor()` 方法标记为 `@Deprecated`
  - 提取方法以消除代码重复：
    - `updateBrickPanelPosition()` - 消除重复的位置计算代码
    - `handleGameKeyPress()` - 简化按键处理逻辑
    - `showScoreNotification()` - 提高代码可读性
  - 改进布尔比较（使用 `!isPause.getValue()` 替代 `isPause.getValue() == Boolean.FALSE`）
  - 为所有公共方法和重要私有方法添加Javadoc文档
  - 添加常量 `displayStartRow = 2` 提高可读性
  - **新增功能**: 实现分数实时显示
    - 添加 `scoreLabel` 字段用于显示分数
    - 实现 `bindScore()` 方法，使用JavaFX属性绑定实现分数自动更新
    - 添加Label导入
- **修改理由**: 改进代码结构，减少重复，提高可维护性，实现分数实时显示功能

### 5. `GameController`
- **位置**: `com.comp2042.GameController`
- **修改内容**:
  - 将 `board` 字段改为 `final`，在构造函数中初始化
  - 使用 `GameConstants.BOARD_HEIGHT` 和 `BOARD_WIDTH` 替代硬编码的游戏板尺寸
  - 改进构造函数参数命名（c → guiController）
  - 为类和方法添加Javadoc文档
  - 在 `onDownEvent()` 中添加逻辑说明注释
  - **分数逻辑修复**: 移除了按向下键时的分数累加逻辑，确保只在消除行后才累加分数
- **修改理由**: 提高代码可读性，改进封装性，便于理解业务逻辑，修复分数累加规则

### 6. `Main`
- **位置**: `com.comp2042.Main`
- **修改内容**:
  - 添加包含作者和版本信息的类级别Javadoc
  - 使用 `GameConstants.GAME_WINDOW_WIDTH` 和 `GAME_WINDOW_HEIGHT` 替代硬编码的窗口尺寸
  - 改进变量命名（c → guiController）
  - 移除未使用的导入（ResourceBundle）
  - 为关键步骤添加注释
- **修改理由**: 使代码更专业，提高可维护性

### 7. `Score`
- **位置**: `com.comp2042.Score`
- **修改内容**:
  - 为类和方法添加完整的Javadoc文档
  - 改进方法参数命名（i → points）
  - 添加 `getValue()` 方法以获取当前分数
- **修改理由**: 提高API完整性，改进代码可读性

### 8. `BrickRotator`
- **位置**: `com.comp2042.BrickRotator`
- **修改内容**:
  - 为类和方法添加完整的Javadoc文档
  - 简化 `getNextShape()` 方法的实现
  - 改进参数命名（在setter中：currentShape → shapeIndex）
- **修改理由**: 使代码更清晰，逻辑更易理解

## 系统维护和扩展的核心修改内容

### 分数实时显示功能（功能扩展）

#### 1. FXML界面更新
- **位置**: `gameLayout.fxml`
- **功能**: 
  - 在游戏板右上角添加分数显示区域
  - 使用VBox布局组织"SCORE"标签和分数值标签
  - 分数标签使用fx:id="scoreLabel"以便在控制器中绑定
- **实现**: 添加VBox容器，包含标题标签和分数值标签
- **位置调整**: 初始位置在layoutX="200"会与游戏区域重叠，修复后调整为layoutX="260", layoutY="10"，位于游戏区域右上角

#### 2. GUI控制器实现
- **位置**: `GuiController.java`
- **功能**:
  - 添加 `@FXML` 注解的 `scoreLabel` 字段
  - 实现 `bindScore()` 方法，使用JavaFX属性绑定
  - 分数变化时自动更新显示
- **实现**: 
  - 使用 `textProperty().bind(integerProperty.asString())` 实现自动绑定
  - 当分数属性值改变时，Label文本自动更新

#### 3. CSS样式美化
- **位置**: `window_style.css`
- **功能**: 
  - 添加 `scoreLabelStyle` 样式类（标题样式）
  - 添加 `scoreValueStyle` 样式类（分数值样式）
  - 使用数字字体和黄色高亮显示
- **实现**: 使用"Let's go Digital"字体，黄色文字，加粗显示

#### 4. 分数累加逻辑修复
- **位置**: `GameController.java`
- **问题**: 初始实现中，用户按向下键就会累加分数（BASE_SCORE_PER_DOWN），不符合游戏规则
- **修复**: 移除了按向下键时的分数累加逻辑，现在只在消除行后才累加分数
- **实现**: 删除了 `onDownEvent()` 方法中 `else` 分支的分数累加代码，确保分数只在 `clearRow.getLinesRemoved() > 0` 时增加

#### 5. 窗口尺寸调整
- **位置**: `GameConstants.java`
- **修改**: 将 `GAME_WINDOW_WIDTH` 从300增加到350，以容纳右上角的分数显示
- **理由**: 确保分数显示不会超出窗口边界，保持良好的视觉效果

#### 6. 功能特点
- **实时更新**: 分数变化时立即更新显示，无需手动刷新
- **自动绑定**: 使用JavaFX属性绑定机制，代码简洁高效
- **美观显示**: 使用数字字体和醒目的黄色，易于阅读
- **位置合理**: 分数显示在游戏板右上角，不遮挡游戏区域
- **逻辑正确**: 只在消除行后才累加分数，符合游戏规则

### Bug修复：游戏结束逻辑

#### 问题描述
- **Bug**: 俄罗斯方块未达到游戏板顶端即提前结束游戏
- **位置**: `SimpleBoard.createNewBrick()` 方法和 `GameConstants.INITIAL_BRICK_Y`
- **原因**: 初始方块生成位置Y坐标设置为10，导致方块从游戏板中间位置生成。当方块堆叠到Y=10附近时，新方块在初始位置（Y=10）就会与已堆叠的方块发生碰撞，导致游戏过早结束

#### 修复方案
1. **修改初始方块位置**:
   - **位置**: `GameConstants.INITIAL_BRICK_Y`
   - **修改**: 将初始Y坐标从10改为0
   - **理由**: 方块应该从游戏板顶部（Y=0）生成，符合俄罗斯方块的标准玩法

2. **改进游戏结束判断逻辑**:
   - **位置**: `SimpleBoard.createNewBrick()` 方法
   - **修改**: 添加注释说明游戏结束条件
   - **逻辑**: 只有当新方块在顶部生成位置（Y=0）无法放置时，才判定游戏结束
   - **理由**: 确保游戏只在方块真正堆叠到顶部时才结束

#### 修复效果
- ✅ 方块现在从游戏板顶部正确生成
- ✅ 游戏只在方块堆叠到顶部时才结束
- ✅ 符合俄罗斯方块的标准游戏规则

### 代码重构（维护工作）

#### 1. 魔法数字消除
- **位置**: 多个文件
- **修改内容**: 创建 `GameConstants` 类集中管理所有配置值
  - 影响文件：`SimpleBoard.java`, `GameController.java`, `GuiController.java`, `Main.java`, `MatrixOperations.java`
- **修改理由**: 提高代码可读性和可维护性，便于统一修改配置

#### 2. 设计模式应用
- **位置**: `ColorMapper` 类及相关文件
- **修改内容**: 实现策略模式处理颜色映射
  - 创建 `ColorMapper` 类
  - 影响文件：`GuiController.java`
- **修改理由**: 分离关注点，改进代码组织，便于扩展

#### 3. 代码组织改进
- **位置**: `GuiController.java`
- **修改内容**: 提取方法以减少重复
  - `updateBrickPanelPosition()`
  - `handleGameKeyPress()`
  - `showScoreNotification()`
- **修改理由**: 遵循DRY原则，提高可维护性

#### 4. 文档完善
- **位置**: 所有公共类
- **修改内容**: 添加完整的Javadoc文档
  - 所有公共类和主要方法现在都有完整的文档
- **修改理由**: 提高代码可理解性和可维护性

#### 5. 代码质量提升
- **位置**: 多个文件
- **修改内容**:
  - 改进变量和参数命名
  - 增强封装（final类，私有构造函数）
  - 简化布尔逻辑
- **修改理由**: 遵循最佳实践，提高代码质量

## 意外问题

### 问题1：游戏过早结束Bug
- **问题描述**: 俄罗斯方块未达到游戏板顶端即提前结束游戏
- **发现**: 在测试过程中发现方块堆叠到中间位置时游戏就结束了
- **原因分析**: 
  - 初始方块生成位置Y坐标设置为10（游戏板中间位置）
  - 当方块堆叠到Y=10附近时，新方块在初始位置就会与已堆叠方块碰撞
  - 导致游戏过早结束
- **解决方案**: 
  - 将初始Y坐标改为0（游戏板顶部）
  - 改进游戏结束判断逻辑，确保只在顶部无法放置时才结束
- **位置**: `GameConstants.INITIAL_BRICK_Y`, `SimpleBoard.createNewBrick()`

### 问题2：Java版本兼容性
- **问题描述**: 项目最初要求Java 23，但系统安装的是Java 8
- **解决方案**: 
  - 安装了JDK 23.0.2
  - 设置JAVA_HOME环境变量指向JDK 23
  - 使用 `mvn clean compile` 验证编译
- **位置**: `pom.xml`（Java版本配置）

### 问题3：Maven Javadoc插件配置
- **问题描述**: Javadoc生成需要正确的插件配置
- **解决方案**: 
  - 在 `pom.xml` 中添加 `maven-javadoc-plugin` 配置
  - 配置源代码/目标版本、编码和文档标题
  - 成功生成Javadoc文档
- **位置**: `pom.xml`（构建插件部分）

### 问题4：代码注释语言
- **问题描述**: 初始代码注释为中文，但项目要求使用英文
- **解决方案**: 
  - 将所有Javadoc注释和内联注释转换为英文
  - 确保所有文档遵循英文语言标准
- **位置**: 所有Java源文件

### 问题5：分数累加逻辑错误
- **问题描述**: 实现分数显示功能后，发现按向下键就会累加分数，不符合游戏规则
- **发现**: 在测试过程中发现即使没有消除行，按向下键也会增加分数
- **原因分析**: 
  - `GameController.onDownEvent()` 方法中，当方块可以继续下移时，会检查事件来源
  - 如果事件来源是用户（USER），就会累加 `BASE_SCORE_PER_DOWN` 分数
  - 这导致用户每次按向下键都会获得分数，不符合俄罗斯方块的游戏规则
- **解决方案**: 
  - 移除了 `onDownEvent()` 方法中 `else` 分支的分数累加代码
  - 确保分数只在消除行后（`clearRow.getLinesRemoved() > 0`）才累加
- **位置**: `GameController.onDownEvent()` 方法
- **效果**: 分数现在只在正确消除行后才增加，符合游戏规则

### 问题6：分数显示位置重叠
- **问题描述**: 分数显示位置偏左，与游戏区域重叠
- **发现**: 在测试过程中发现分数显示在layoutX="200"的位置，与游戏面板重叠
- **原因分析**: 
  - 游戏面板位于layoutX="40"，宽度约为10个方块（每个20像素）= 200像素
  - 游戏区域实际占据40-240像素的宽度
  - 分数显示在200像素位置会与游戏区域右侧重叠
- **解决方案**: 
  - 将分数显示位置从 `layoutX="200", layoutY="30"` 调整为 `layoutX="260", layoutY="10"`
  - 将窗口宽度从300增加到350，以容纳右上角的分数显示
- **位置**: `gameLayout.fxml`, `GameConstants.GAME_WINDOW_WIDTH`
- **效果**: 分数显示现在位于游戏区域右上角，不再重叠，视觉效果更好

## 设计模式应用

### 策略模式 (Strategy Pattern)
- **应用位置**: `ColorMapper` 类
- **目的**: 将颜色映射逻辑从GUI控制器中分离
- **优势**: 
  - 单一职责原则
  - 易于扩展新的颜色映射策略
  - 提高代码复用性

## 遵循的设计原则

1. **单一职责原则 (SRP)**: 
   - `ColorMapper` 仅负责颜色映射
   - `GameConstants` 仅负责常量管理

2. **开闭原则 (OCP)**: 
   - 颜色映射可以扩展而不修改现有代码

3. **DRY原则 (Don't Repeat Yourself)**: 
   - 将重复代码提取到方法中（如 `updateBrickPanelPosition()`）

4. **封装原则**: 
   - 工具类使用私有构造函数防止实例化
   - 改进字段访问控制

## 项目结构

```
CW2025/
├── src/
│   └── main/
│       ├── java/
│       │   └── com/
│       │       └── comp2042/
│       │           ├── util/          # 新增工具类
│       │           │   ├── GameConstants.java
│       │           │   └── ColorMapper.java
│       │           ├── logic/
│       │           │   └── bricks/    # 方块类
│       │           └── [其他游戏类]
│       └── resources/
│           ├── gameLayout.fxml
│           ├── window_style.css
│           └── [其他资源]
├── Javadoc/                           # 生成的API文档
├── pom.xml
├── README.md                          # 本文件
└── [其他项目文件]
```

## 测试

重构后的代码保持了所有原有功能：
- ✅ 所有游戏功能正常工作
- ✅ 代码编译无错误
- ✅ 应用程序成功运行
- ✅ 未引入回归问题

## 总结

本次课程作业专注于代码维护和重构，显著提高了代码质量：
- ✅ 消除了所有魔法数字
- ✅ 添加了完整的Javadoc文档
- ✅ 应用了设计模式（策略模式）
- ✅ 改进了代码组织和命名
- ✅ 提高了代码可维护性和可读性
- ✅ 修复了游戏过早结束的bug
- ✅ 实现了分数实时显示功能
- ✅ 修复了分数累加逻辑和显示位置问题

### 功能扩展成果
- ✅ 实现了分数实时统计显示功能
- ✅ 使用JavaFX属性绑定实现自动更新
- ✅ 分数显示位置合理，样式美观
- ✅ 分数累加逻辑正确，只在消除行后累加
- ✅ 修复了分数显示位置重叠问题
- ✅ 提升了游戏用户体验

### Bug修复成果
- ✅ 修复了俄罗斯方块未达到顶端即结束游戏的bug
- ✅ 方块现在从游戏板顶部正确生成
- ✅ 游戏结束逻辑符合标准俄罗斯方块规则

所有重构、功能扩展和修复工作都保持了原有功能的完整性，代码可以正常编译和运行。
